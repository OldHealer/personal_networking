# План разработки: Rockfile

## Обзор

План разбит на фазы от MVP до полномасштабного продукта. Каждая фаза завершается рабочим инкрементом, который можно продемонстрировать или использовать.

---

## Фаза 0: Подготовка инфраструктуры

**Цель:** Миграции, структура проекта, базовые зависимости.

| # | Задача | Результат |
|---|--------|-----------|
| 0.1 | Настроить Alembic для async SQLAlchemy | `alembic init`, конфиг под asyncpg |
| 0.2 | Создать первую миграцию по текущим моделям | `contact_cards`, `contact_links`, `contact_interactions` |
| 0.3 | Добавить в pyproject: pytest, pytest-asyncio, httpx | Готовность к тестам |
| 0.4 | Опционально: docker-compose с PostgreSQL | Локальный запуск БД одной командой |

**Выход:** БД создаётся через миграции, проект готов к разработке API.

---

## Фаза 1: MVP API (Карточки и базовый CRUD)

**Цель:** Работающий CRUD для карточек контактов.

### 1.1 Схемы Pydantic

| # | Задача | Результат |
|---|--------|-----------|
| 1.1.1 | `ContactCardCreate` — создание карточки | Схема с обязательными/опциональными полями |
| 1.1.2 | `ContactCardUpdate` — частичное обновление | Все поля optional |
| 1.1.3 | `ContactCardResponse` — ответ API | Сериализация из ORM |
| 1.1.4 | `ContactCardListResponse` — список с пагинацией | `items`, `total`, `page`, `per_page` |

### 1.2 Роутер контактов

| # | Задача | Результат |
|---|--------|-----------|
| 1.2.1 | `GET /api/v1/contacts` — список с пагинацией | `page`, `per_page`, сортировка по имени |
| 1.2.2 | `POST /api/v1/contacts` — создание | Валидация, возврат созданной карточки |
| 1.2.3 | `GET /api/v1/contacts/{id}` | Карточка по ID, 404 при отсутствии |
| 1.2.4 | `PATCH /api/v1/contacts/{id}` | Частичное обновление |
| 1.2.5 | `DELETE /api/v1/contacts/{id}` | Мягкое или жёсткое удаление |

### 1.3 Сервисный слой (опционально на MVP)

| # | Задача | Результат |
|---|--------|-----------|
| 1.3.1 | `ContactService` — обёртка над DAO | Централизация логики, проще тестировать |

### 1.4 Интеграция

| # | Задача | Результат |
|---|--------|-----------|
| 1.4.1 | Подключить роутер в `fastapi_app` | Маршруты доступны |
| 1.4.2 | Dependency injection для сессии БД | `get_db()` через `yield` |
| 1.4.3 | Глобальный обработчик ошибок | 404, 422, 500 в едином формате |

**Выход:** Можно создавать, читать, обновлять и удалять карточки через Swagger/ReDoc.

---

## Фаза 2: Связи между контактами и взаимодействия

**Цель:** ContactLink (связи «кто кого знает») и CRUD для взаимодействий. Каждый человек — полноценная карточка; связи описывают граф отношений.

### 2.1 Схемы

| # | Задача | Результат |
|---|--------|-----------|
| 2.1.1 | `ContactLinkCreate`, `ContactLinkResponse` | Схемы для связей между контактами (contact_a, contact_b, relationship_type, context) |
| 2.1.2 | `ContactInteractionCreate`, `ContactInteractionResponse` | Схемы для взаимодействий |
| 2.1.3 | Добавить `known_through_contact_id` в `ContactCard` (опционально) | Через кого познакомился |

### 2.2 Роутеры

| # | Задача | Результат |
|---|--------|-----------|
| 2.2.1 | `GET/POST /api/v1/contacts/{id}/links` | Список связей контакта и добавление связи с другим контактом |
| 2.2.2 | `PATCH/DELETE /api/v1/contacts/{id}/links/{link_id}` | Редактирование и удаление связи |
| 2.2.3 | `GET /api/v1/links` | Все связи (для визуализации графа) |
| 2.2.4 | `GET/POST /api/v1/contacts/{id}/interactions` | Список и добавление взаимодействий |
| 2.2.5 | `PATCH/DELETE /api/v1/contacts/{id}/interactions/{int_id}` | Редактирование и удаление |

### 2.3 Бизнес-логика

| # | Задача | Результат |
|---|--------|-----------|
| 2.3.1 | При добавлении Interaction обновлять `last_contact_at`, `last_contact_summary` у ContactCard | Автоматическая актуализация карточки |
| 2.3.2 | При добавлении Interaction с `promises` — агрегировать их в `ContactCard.promises` (с `interaction_id`, `direction`, `completed_at`) | Связь обещаний: Interaction = источник, Card = сводка активных |
| 2.3.3 | Эндпоинт/действие для отметки обещания выполненным (удаление из Card или флаг `completed_at`) | Обновление карточки без потери истории в Interaction |
| 2.3.4 | При запросе `GET /contacts/{id}` подгружать `links` (связанные контакты), `interactions` | Полная карточка с графом связей |

**Выход:** Полноценная карточка с графом связей и историей контактов, корректная агрегация обещаний.

---

## Фаза 3: Поиск и фильтрация

**Цель:** Удобный поиск по картотеке.

### 3.1 Простой поиск

| # | Задача | Результат |
|---|--------|-----------|
| 3.1.1 | Параметр `q` в `GET /contacts` | Поиск по `full_name`, `email` (ILIKE) |
| 3.1.2 | Фильтр `relationship_type` | business / personal / other |
| 3.1.3 | Сортировка `sort` | `name`, `last_contact_at`, `created_at` + `asc`/`desc` |

### 3.2 Полнотекстовый поиск (опционально)

| # | Задача | Результат |
|---|--------|-----------|
| 3.2.1 | Миграция: добавить `tsvector` и GIN-индекс | Поиск по заметкам, интересам |
| 3.2.2 | Эндпоинт `GET /api/v1/search?q=` | Использование `to_tsquery` |

### 3.3 Полезные фильтры

| # | Задача | Результат |
|---|--------|-----------|
| 3.3.1 | `has_birthday_soon` (N дней) | Карточки с ДР в ближайшие N дней |
| 3.3.2 | `last_contact_before` (N дней) | С кем давно не общались |

**Выход:** Эффективный поиск и фильтрация по картотеке.

---

## Фаза 4: Авторизация и мультитенантность

**Цель:** Каждый пользователь видит только свои карточки.

| # | Задача | Результат |
|---|--------|-----------|
| 4.1 | Добавить `User` и `user_id` в `ContactCard` | Связь карточки с владельцем |
| 4.2 | JWT-авторизация (или OAuth2) | Middleware/Depends для проверки токена |
| 4.3 | Эндпоинт `POST /auth/login` (и при необходимости регистрация) | Выдача токена |
| 4.4 | Фильтрация всех запросов по `user_id` | Изоляция данных |

**Выход:** Безопасное мультипользовательское приложение.

---

## Фаза 5: Расширенные возможности

**Цель:** Дополнительный функционал для удобства.

| # | Задача | Результат |
|---|--------|-----------|
| 5.1 | Теги (`ContactTag`, many-to-many с ContactCard) | Группировка по сферам, проектам |
| 5.2 | Напоминания (`ContactReminder`) | Напоминания о follow-up, ДР |
| 5.3 | Связи между контактами (`ContactLink`) | Кто с кем связан |
| 5.4 | Импорт/экспорт (CSV, JSON) | Перенос данных |

**Выход:** Расширенная картотека с тегами, напоминаниями и связями.

---

## Фаза 6: Веб-фронтенд (HTML, CSS, JS)

**Примечание:** Фронтенд разрабатывается **после** стабилизации API (API-first).

| # | Задача | Результат |
|---|--------|-----------|
| 6.1 | HTML-шаблоны, CSS-стили | Список карточек, форма создания/редактирования (классический веб, не SPA) |
| 6.2 | JavaScript для работы с API (fetch/XHR) | CRUD, загрузка данных без перезагрузки (или с ней) |
| 6.3 | CORS, интеграция с бэкендом | Корректная работа веб-клиента с FastAPI |
| 6.4 | Поиск, фильтры в UI | Удобный интерфейс поиска |

---

## Фаза 7: ИИ-агент (перспектива)

**Цель:** Агент, использующий данные картотеки для напоминаний и подсказок.

| # | Задача | Результат |
|---|--------|-----------|
| 7.1 | API/воркер: напоминания о днях рождения | За N дней до ДР контакта и членов семьи |
| 7.2 | Напоминания об обещаниях и `follow_up_by` | Уведомления о просроченных/предстоящих обязательствах |
| 7.3 | «Забытые контакты» — с кем давно не общался | Список по `last_contact_at` + краткая выжимка |
| 7.4 | Подготовка к встрече: памятка по контакту | Последний контакт, обещания, интересы |
| 7.5 | Персонализированные подсказки (опционально LLM) | По интересам, заметкам, семейным событиям |
| 7.6 | Еженедельный дайджест | ДР, обещания, контакты без общения |

**Выход:** ИИ-агент как отдельный сервис/воркер, работающий с API.

---

## Фаза 8: Мобильное приложение (перспектива)

**Цель:** Синхронизируемое мобильное приложение (данные в мобилке → отображаются в веб и наоборот).

| # | Задача | Результат |
|---|--------|-----------|
| 8.1 | Тот же REST API — основа для мобильного клиента | Единый источник правды |
| 8.2 | Стратегия синхронизации (онлайн-first или гибрид) | Версионирование сущностей, разрешение конфликтов |
| 8.3 | Flutter / React Native / нативный клиент | iOS и Android |
| 8.4 | Push-уведомления (для напоминаний от ИИ-агента) | Интеграция с Firebase/APNs |
| 8.5 | Оффлайн-режим (опционально) | Локальное хранилище + очередь синхронизации |

**Выход:** Мобильное приложение, синхронизируемое с веб-версией через общий API.

---

## Приоритеты и порядок выполнения

| Фаза | Приоритет | Зависимости |
|------|-----------|-------------|
| 0 | Высокий | — |
| 1 | Высокий | 0 |
| 2 | Высокий | 1 |
| 3 | Средний | 1, 2 |
| 4 | Средний | 1, 2 |
| 5 | Низкий | 1–4 |
| 6 | Средний | 1–4 (API-first: сначала API) |
| 7 | Низкий | 1–5 |
| 8 | Низкий | 1–5 |

---

## Чек-лист перед началом каждой фазы

- [ ] Прошли все тесты предыдущей фазы
- [ ] Миграции применены
- [ ] Документация API актуальна (Swagger)

---

## Оценка трудозатрат (ориентировочно)

| Фаза | Оценка |
|------|--------|
| 0 | 0.5–1 день |
| 1 | 2–3 дня |
| 2 | 2–3 дня (с логикой обещаний) |
| 3 | 1–2 дня |
| 4 | 2–3 дня |
| 5 | 3–5 дней |
| 6 | 5–8 дней (HTML/CSS/JS) |
| 7 | 5–10 дней (ИИ-агент) |
| 8 | 15–25 дней (мобильное приложение) |

**MVP (фазы 0–2):** примерно 5–7 дней разработки.
